# 「ほる」新機能3種 実装仕様書（Claude Code用）

## 概要

「ほる（dig）」タブに以下の3つのデイリー機能を追加する。いずれも**1日1回制限**で、回答からAIが特徴（トレイト）を抽出して保存する。

| 機能 | ID | 所要時間 | 抽出トレイト数 |
|------|----|---------|--------------|
| ガチャ質問 | `gacha` | 30秒 | 1〜2個 |
| 自分を○○に例えると？ | `metaphor` | 1分 | 1〜2個 |
| あなたの好きな○○ | `favorites` | 1分 | 1〜2個 |

---

## 1. 共通アーキテクチャ

### 1.1 1日1回制限の実装

既存のスワイプ診断と同じ `localStorage` パターンを使う。

```typescript
// 各機能ごとにキーを分ける
const DAILY_KEYS = {
  gacha: 'lastGachaDate',
  metaphor: 'lastMetaphorDate',
  favorites: 'lastFavoritesDate',
} as const;

// チェック関数
function isUsedToday(key: string): boolean {
  const lastDate = localStorage.getItem(key);
  return lastDate === new Date().toISOString().slice(0, 10);
}

// 使用済みマーク
function markUsedToday(key: string): void {
  localStorage.setItem(key, new Date().toISOString().slice(0, 10));
}
```

### 1.2 共通APIルート

3機能とも同じAPIエンドポイントで処理する。

**エンドポイント**: `POST /api/daily-dig`

```typescript
// src/app/api/daily-dig/route.ts

interface DailyDigRequest {
  type: 'gacha' | 'metaphor' | 'favorites';
  question: string;    // 出題された質問テキスト
  answer: string;      // ユーザーの回答テキスト
  existingTraits: UserTrait[];  // 既存特徴（重複排除用）
}

interface DailyDigResponse {
  traits: UserTrait[];
  comment: string;  // AIからの一言コメント（結果画面用）
}
```

**処理フロー**:
1. `verifyAuth()` で認証検証（匿名ユーザーもOK ← スワイプ診断と同じ）
2. リクエストのバリデーション
3. type に応じたプロンプトで Gemini API 呼び出し
4. 特徴をパースして返却

**Gemini プロンプト（共通ベース）**:

```
あなたはユーザーの個性を発見する専門家です。
以下の質問と回答から、ユーザーの特徴を1〜2個抽出してJSON形式で出力してください。

【質問タイプ】{type}
【質問】{question}
【ユーザーの回答】{answer}

【既存の特徴ラベル一覧】
{existingTraitLabels}
※ 上記と同じ・類似のラベルは避け、新しい切り口の特徴を抽出すること

【出力形式】
{
  "traits": [
    {
      "label": "キャッチーなラベル（3〜6文字の二つ名・称号）",
      "category": "personality|hobby|skill|work|value|lifestyle|experience|other",
      "icon": "絵文字1つ",
      "description": "特徴の詳細説明（30文字以内）",
      "keywords": ["関連キーワード1", "関連キーワード2"],
      "intensityLabel": "強弱キーワードまたはnull",
      "confidence": 0.6〜0.85の数値
    }
  ],
  "comment": "ユーザーへの一言コメント（40文字以内、ポジティブで共感的なトーン）"
}

【★最重要：ラベルの付け方】
ラベルはSNSプロフィールに貼りたくなるような「二つ名・称号」にしてください。
- 3〜6文字の短くてキャッチーな造語・組み合わせ語にする
- 「◯◯な人」「◯◯がある」のような説明文にしない
- 具体的な名詞・比喩・擬人化を使い、読んだ瞬間に意味が伝わるものにする
- ポジティブで、本人が「自分を表す言葉」として誇れる表現にする

良い例：「深掘り職人」「共感アンテナ」「直感キャッチャー」「没頭エンジン」「裏方の鬼」「冒険イノベーター」「分析マスター」「ひらめきの泉」「橋渡し名人」「こだわり研究家」
悪い例：「社交的」「几帳面」「好奇心旺盛」「読書好き」→ ただの形容詞・説明文はNG

【注意事項】
- JSON以外のテキストは出力しないでください
- 短い回答でも、選択・表現の仕方から特徴を読み取ってください
- commentは「へぇ！」「なるほど！」のような軽い反応 + 回答への一言感想
```

**type別の追加プロンプト指示**:

- `gacha`: 「回答の内容だけでなく、回答のしかた（具体的/抽象的、ポジティブ/ネガティブ、即答的/熟考的）からも特徴を読み取ってください」
- `metaphor`: 「選んだ比喩対象の特性と、その理由の両方から特徴を抽出してください。例えば"猫"を選んだ理由が"マイペースだから"なら、行動パターンに着目した特徴を抽出してください」
- `favorites`: 「好きなものの選び方（定番/マニアック、感性重視/論理重視）や、理由の述べ方から、趣味嗜好だけでなく価値観・思考パターンも読み取ってください」

### 1.3 共通の結果保存フロー

スワイプ診断と同じパターンで保存する：

1. フロントで `sessionStorage` に結果を一時保存
2. 結果ページで表示 & Firestore に自動保存
3. 保存は `authenticatedFetch('/api/save-interview')` → `authenticatedFetch('/api/save-traits')` の順

**注意**: スワイプ診断の結果ページ (`/dig/swipe/result/page.tsx`) のロジックを参考にすること。特に `save-interview` → `save-traits` の2段階保存パターンは同じ方法を使う。

### 1.4 ルーティング

```
src/app/(main)/dig/
├── gacha/
│   ├── page.tsx          # ガチャ質問メイン画面
│   └── result/
│       └── page.tsx      # 結果画面
├── metaphor/
│   ├── page.tsx          # 例え質問メイン画面
│   └── result/
│       └── page.tsx      # 結果画面
├── favorites/
│   ├── page.tsx          # 好きなもの質問メイン画面
│   └── result/
│       └── page.tsx      # 結果画面
└── page.tsx              # ほるトップ（既存 — MenuCard追加）
```

---

## 2. ガチャ質問（gacha）

### 2.1 概要

1日1回、ランダムなジャンルの質問が出る。テキスト入力で回答し、AIが特徴を抽出。

### 2.2 質問データ

`src/lib/gachaQuestions.ts` を新規作成。

```typescript
export interface GachaQuestion {
  id: string;
  question: string;
  category: string;  // 質問のジャンル（表示用）
  placeholder: string;  // 入力欄のプレースホルダー
}

const GACHA_QUESTIONS: GachaQuestion[] = [
  // 価値観・哲学
  { id: 'g01', question: '人生で一番大切にしていることは？', category: '価値観', placeholder: '例：家族との時間、自由...' },
  { id: 'g02', question: '「これだけは譲れない」ってことある？', category: '価値観', placeholder: '例：睡眠時間、自分の時間...' },
  { id: 'g03', question: '10年後の自分に一言伝えるとしたら？', category: '未来', placeholder: '自由に書いてね' },
  { id: 'g04', question: '子供の頃、将来の夢は何だった？', category: '過去', placeholder: '例：パイロット、ケーキ屋...' },
  { id: 'g05', question: '最近「これやってよかった！」と思ったことは？', category: '体験', placeholder: '例：朝のランニング、資格勉強...' },

  // 日常・ライフスタイル
  { id: 'g06', question: '今の自分を充電するために何する？', category: 'リフレッシュ', placeholder: '例：散歩、音楽を聴く...' },
  { id: 'g07', question: '朝起きて一番にすることは？', category: '習慣', placeholder: '例：コーヒーを淹れる...' },
  { id: 'g08', question: '今、無限にお金があったら何する？', category: '妄想', placeholder: '自由に書いてね' },
  { id: 'g09', question: 'つい時間を忘れて没頭しちゃうことは？', category: '没頭', placeholder: '例：ゲーム、読書、DIY...' },
  { id: 'g10', question: '最後の晩餐、何食べる？', category: '食', placeholder: '例：おばあちゃんの肉じゃが...' },

  // 対人・コミュニケーション
  { id: 'g11', question: '友達からどんな人だと思われてると思う？', category: '他者視点', placeholder: '例：聞き上手、面白い...' },
  { id: 'g12', question: '初対面の人と話すとき、最初に何を聞く？', category: 'コミュニケーション', placeholder: '例：出身地、仕事...' },
  { id: 'g13', question: '「ありがとう」って最近誰に言った？何で？', category: '感謝', placeholder: '例：同僚に、助けてもらって...' },
  { id: 'g14', question: '一番影響を受けた人は誰？', category: '人間関係', placeholder: '例：母親、恩師...' },
  { id: 'g15', question: 'チームで任されることが多い役割は？', category: '役割', placeholder: '例：まとめ役、アイデア出し...' },

  // 仕事・キャリア
  { id: 'g16', question: '仕事でテンションが上がる瞬間は？', category: '仕事', placeholder: '例：企画が通った時...' },
  { id: 'g17', question: '「これは得意かも」と密かに思ってることは？', category: 'スキル', placeholder: '例：段取り、プレゼン...' },
  { id: 'g18', question: '仕事で「これだけは嫌」ってことある？', category: '仕事', placeholder: '例：単調な作業、嘘をつくこと...' },

  // 感性・趣味
  { id: 'g19', question: '最近グッときた言葉やフレーズは？', category: '感性', placeholder: '例：歌の歌詞、名言...' },
  { id: 'g20', question: '旅行するなら都会派？自然派？', category: '旅', placeholder: '理由も教えて！' },
  { id: 'g21', question: 'もし1日だけ別の職業を体験できるとしたら？', category: '妄想', placeholder: '例：宇宙飛行士、パティシエ...' },
  { id: 'g22', question: '今の気分を天気で表すと？', category: '感情', placeholder: '例：晴れ、くもり時々晴れ...' },
  { id: 'g23', question: '人生のテーマソングがあるとしたら何？', category: '感性', placeholder: '曲名でも雰囲気でもOK' },
  { id: 'g24', question: '生まれ変わったらなりたいものは？', category: '妄想', placeholder: '人でも動物でも何でもOK' },
  { id: 'g25', question: '密かに自慢できることを一つ教えて！', category: '自慢', placeholder: '些細なことでもOK！' },

  // ちょっと深い系
  { id: 'g26', question: '最近の「小さな幸せ」は何だった？', category: '幸せ', placeholder: '例：猫が膝に乗ってきた...' },
  { id: 'g27', question: '自分の性格で一番好きなところは？', category: '自己肯定', placeholder: '例：切り替えが早い...' },
  { id: 'g28', question: '5年前の自分に「大丈夫」と言えること何？', category: '成長', placeholder: '自由に書いてね' },
  { id: 'g29', question: '誰かに教えたい、自分だけの豆知識は？', category: '知識', placeholder: '例：美味しいコーヒーの淹れ方...' },
  { id: 'g30', question: '休日の朝、理想の過ごし方は？', category: 'ライフスタイル', placeholder: '例：カフェでのんびり...' },
];

/**
 * ランダムに1問選ぶ（前回と被らないように）
 */
export function getRandomGachaQuestion(): GachaQuestion {
  const lastId = localStorage.getItem('lastGachaQuestionId');
  const candidates = GACHA_QUESTIONS.filter(q => q.id !== lastId);
  const selected = candidates[Math.floor(Math.random() * candidates.length)];
  localStorage.setItem('lastGachaQuestionId', selected.id);
  return selected;
}

export { GACHA_QUESTIONS };
```

### 2.3 UI仕様（`/dig/gacha/page.tsx`）

**画面構成**:

```
┌──────────────────────────────┐
│ ← ガチャ質問                  │
├──────────────────────────────┤
│                              │
│  🎰 今日の質問               │
│                              │
│  ┌──────────────────────┐   │
│  │  カテゴリバッジ         │   │  ← 例：「価値観」
│  │                        │   │
│  │  質問テキスト           │   │  ← 大きめフォント
│  │  （例：人生で一番大切に  │   │
│  │   していることは？）     │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │  テキスト入力欄         │   │  ← textarea, 3行程度
│  │  placeholder表示        │   │
│  └──────────────────────┘   │
│                              │
│  文字数: 0/200               │
│                              │
│  ┌──────────────────────┐   │
│  │    回答する ▶          │   │  ← btn-gradient-primary
│  └──────────────────────┘   │  ← 10文字以上で有効化
│                              │
└──────────────────────────────┘
```

**動作フロー**:
1. `useEffect` で `isUsedToday('lastGachaDate')` チェック → 使用済みなら `/dig` にリダイレクト
2. `getRandomGachaQuestion()` で質問取得
3. ユーザーが回答入力（10文字以上で送信ボタン有効化、最大200文字）
4. 送信 → `markUsedToday('lastGachaDate')` → API呼び出し → ローディング表示
5. 結果を `sessionStorage.setItem('gacha-result', JSON.stringify(data))` に保存
6. `/dig/gacha/result` にルーター遷移

**ローディング中の表示**:
```
あなたの回答を分析中... ⛏
```

### 2.4 結果ページ（`/dig/gacha/result/page.tsx`）

スワイプ診断の結果ページ (`/dig/swipe/result/page.tsx`) と同じ構成。

```
┌──────────────────────────────┐
│  ✨ 新しい特徴を発見！        │
├──────────────────────────────┤
│                              │
│  AIコメント                   │  ← 「へぇ！家族思いなんですね」
│                              │
│  ┌──────────────────────┐   │
│  │  TraitCard (既存)      │   │  ← 発見した特徴カード
│  └──────────────────────┘   │
│  ┌──────────────────────┐   │
│  │  TraitCard (既存)      │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │  じぶんを見にいく →    │   │  → /mypage
│  └──────────────────────┘   │
│  ┌──────────────────────┐   │
│  │  もっとほる →          │   │  → /dig
│  └──────────────────────┘   │
│                              │
└──────────────────────────────┘
```

**自動保存**: `useEffect` でマウント時に `saveTraits()` を実行。スワイプ診断の `result/page.tsx` と同じ `save-interview` → `save-traits` パターン。

---

## 3. 自分を○○に例えると？（metaphor）

### 3.1 概要

ランダムなお題（色、動物、料理、季節など）が出て、ユーザーが「自分を○○に例えると？」に回答。選んだものとその理由から特徴を抽出。

### 3.2 質問データ

`src/lib/metaphorQuestions.ts` を新規作成。

```typescript
export interface MetaphorQuestion {
  id: string;
  theme: string;       // お題カテゴリ名
  question: string;     // 表示する質問文
  icon: string;         // お題のアイコン
  options?: string[];   // 選択肢（任意。なければ自由入力）
  placeholder: string;
}

const METAPHOR_QUESTIONS: MetaphorQuestion[] = [
  // 選択肢あり系
  {
    id: 'm01',
    theme: '色',
    question: '自分を色に例えると何色？',
    icon: '🎨',
    options: ['赤', '青', '黄', '緑', 'オレンジ', '紫', 'ピンク', '白', '黒', '水色'],
    placeholder: '選んだ理由を教えて！',
  },
  {
    id: 'm02',
    theme: '動物',
    question: '自分を動物に例えると？',
    icon: '🐾',
    options: ['犬', '猫', 'うさぎ', 'ライオン', 'イルカ', 'フクロウ', 'ペンギン', 'チーター', 'カメレオン', 'オオカミ'],
    placeholder: '選んだ理由を教えて！',
  },
  {
    id: 'm03',
    theme: '季節',
    question: '自分を季節に例えると？',
    icon: '🌸',
    options: ['春', '夏', '秋', '冬'],
    placeholder: 'なぜその季節？',
  },
  {
    id: 'm04',
    theme: '天気',
    question: '自分を天気に例えると？',
    icon: '☀️',
    options: ['晴れ', 'くもり', '雨', '雪', '雷', '虹', '霧', 'そよ風'],
    placeholder: 'なぜその天気？',
  },
  {
    id: 'm05',
    theme: '飲み物',
    question: '自分を飲み物に例えると？',
    icon: '☕',
    options: ['コーヒー', '紅茶', '緑茶', 'コーラ', 'オレンジジュース', 'ビール', 'ワイン', '水', 'エナジードリンク', 'ココア'],
    placeholder: '選んだ理由を教えて！',
  },
  {
    id: 'm06',
    theme: '料理',
    question: '自分を料理に例えると？',
    icon: '🍳',
    options: ['カレー', '寿司', 'ラーメン', 'パスタ', 'ハンバーグ', 'サラダ', '鍋', 'ピザ', 'お味噌汁', 'チャーハン'],
    placeholder: 'なぜその料理？',
  },
  {
    id: 'm07',
    theme: '場所',
    question: '自分を場所に例えると？',
    icon: '🗺️',
    options: ['図書館', 'カフェ', '海辺', '山頂', '遊園地', '美術館', '公園', 'ライブ会場', '温泉', '駅'],
    placeholder: 'なぜその場所？',
  },
  {
    id: 'm08',
    theme: '時間帯',
    question: '自分を1日の中の時間帯に例えると？',
    icon: '🕐',
    options: ['早朝', '午前中', 'お昼', '午後', '夕暮れ', '夜', '深夜'],
    placeholder: 'なぜその時間帯？',
  },

  // 自由入力系
  {
    id: 'm09',
    theme: '音楽のジャンル',
    question: '自分を音楽のジャンルに例えると？',
    icon: '🎵',
    placeholder: '例：ジャズ、ロック、クラシック... 理由も教えて！',
  },
  {
    id: 'm10',
    theme: '乗り物',
    question: '自分を乗り物に例えると？',
    icon: '🚗',
    options: ['自転車', '電車', '車', '飛行機', '船', 'バイク', 'ロケット', '馬車'],
    placeholder: 'なぜその乗り物？',
  },
  {
    id: 'm11',
    theme: '文房具',
    question: '自分を文房具に例えると？',
    icon: '✏️',
    options: ['鉛筆', 'ボールペン', '消しゴム', 'ノート', 'ハサミ', '定規', 'マーカー', 'ふせん'],
    placeholder: 'なぜそれを選んだ？',
  },
  {
    id: 'm12',
    theme: '映画のジャンル',
    question: '自分を映画のジャンルに例えると？',
    icon: '🎬',
    options: ['アクション', 'コメディ', 'ロマンス', 'ミステリー', 'SF', 'ドキュメンタリー', 'ファンタジー', 'ホラー'],
    placeholder: 'なぜそのジャンル？',
  },
];

export function getRandomMetaphorQuestion(): MetaphorQuestion {
  const lastId = localStorage.getItem('lastMetaphorQuestionId');
  const candidates = METAPHOR_QUESTIONS.filter(q => q.id !== lastId);
  const selected = candidates[Math.floor(Math.random() * candidates.length)];
  localStorage.setItem('lastMetaphorQuestionId', selected.id);
  return selected;
}

export { METAPHOR_QUESTIONS };
```

### 3.3 UI仕様（`/dig/metaphor/page.tsx`）

**画面構成**:

```
┌──────────────────────────────┐
│ ← 自分を○○に例えると？       │
├──────────────────────────────┤
│                              │
│  🎨 今日のお題: 色            │  ← テーマアイコン + テーマ名
│                              │
│  「自分を色に例えると何色？」   │  ← 質問文
│                              │
│  ┌─────┐ ┌─────┐ ┌─────┐   │
│  │ 赤  │ │ 青  │ │ 黄  │   │  ← 選択肢がある場合
│  └─────┘ └─────┘ └─────┘   │     チップ（タップで選択）
│  ┌─────┐ ┌─────┐ ┌─────┐   │     選択済みはハイライト
│  │ 緑  │ │紫   │ │ 白  │   │
│  └─────┘ └─────┘ └─────┘   │
│                              │
│  選んだ理由を教えて！          │
│  ┌──────────────────────┐   │
│  │  テキスト入力欄         │   │  ← textarea, 2行
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │    回答する ▶          │   │  ← 選択肢選択 + 理由5文字以上で有効化
│  └──────────────────────┘   │
│                              │
└──────────────────────────────┘
```

**選択肢のUIパターン**:
- `options` がある場合: チップ形式（flex-wrap）で選択肢を表示。タップで選択状態をトグル。1つだけ選択可能
- `options` がない場合: テキスト入力のみ（例：音楽ジャンル）

**送信データ**:
```typescript
{
  type: 'metaphor',
  question: '自分を色に例えると何色？',
  answer: '青。理由：落ち着いていて、でも深いところがある感じが自分っぽい',  // 「{選択肢}。理由：{理由テキスト}」形式
  existingTraits: [...],
}
```

**バリデーション**: 選択肢あり → 選択済み & 理由5文字以上。選択肢なし → 回答10文字以上。

### 3.4 結果ページ

ガチャ質問と同一構成。`sessionStorage` キーは `'metaphor-result'`。

---

## 4. あなたの好きな○○（favorites）

### 4.1 概要

「あなたの好きな○○を教えて」形式。具体的な好きなものとその理由から、趣味嗜好だけでなく価値観・思考パターンを抽出。

### 4.2 質問データ

`src/lib/favoritesQuestions.ts` を新規作成。

```typescript
export interface FavoritesQuestion {
  id: string;
  theme: string;
  question: string;
  icon: string;
  placeholder: string;
  reasonPlaceholder: string;  // 理由欄のplaceholder
}

const FAVORITES_QUESTIONS: FavoritesQuestion[] = [
  // エンタメ
  { id: 'f01', theme: '映画', question: '一番好きな映画は？', icon: '🎬', placeholder: '例：千と千尋の神隠し', reasonPlaceholder: 'どこが好き？' },
  { id: 'f02', theme: '本', question: '人生で一番影響を受けた本は？', icon: '📚', placeholder: '例：嫌われる勇気', reasonPlaceholder: 'どんな影響を受けた？' },
  { id: 'f03', theme: '音楽', question: '今一番聴いてる曲やアーティストは？', icon: '🎵', placeholder: '例：YOASOBI', reasonPlaceholder: 'なぜハマってる？' },
  { id: 'f04', theme: 'ドラマ/アニメ', question: '一番好きなドラマかアニメは？', icon: '📺', placeholder: '例：鬼滅の刃', reasonPlaceholder: 'どこに惹かれる？' },
  { id: 'f05', theme: 'ゲーム', question: '一番ハマったゲームは？', icon: '🎮', placeholder: '例：あつまれどうぶつの森', reasonPlaceholder: '何が面白かった？' },
  { id: 'f06', theme: 'YouTube/配信', question: 'よく見るYouTuberや配信者は？', icon: '📱', placeholder: '例：ヒカキン', reasonPlaceholder: 'なぜ見てる？' },

  // 食
  { id: 'f07', theme: '食べ物', question: '一番好きな食べ物は？', icon: '🍕', placeholder: '例：お母さんのカレー', reasonPlaceholder: 'なぜそれが一番？' },
  { id: 'f08', theme: 'レストラン/カフェ', question: 'お気に入りのお店は？', icon: '🍽️', placeholder: '例：近所の喫茶店', reasonPlaceholder: 'どこが好き？' },
  { id: 'f09', theme: 'おやつ', question: '疲れた時に食べたいおやつは？', icon: '🍫', placeholder: '例：チョコレート', reasonPlaceholder: 'なぜそれで回復する？' },

  // 場所・旅
  { id: 'f10', theme: '場所', question: '一番好きな場所は？', icon: '📍', placeholder: '例：祖父母の家', reasonPlaceholder: 'なぜその場所？' },
  { id: 'f11', theme: '旅先', question: '今まで行った中で最高の旅先は？', icon: '✈️', placeholder: '例：北海道', reasonPlaceholder: '何がよかった？' },
  { id: 'f12', theme: '景色', question: '今まで見た中で一番きれいだった景色は？', icon: '🌅', placeholder: '例：屋久島の森', reasonPlaceholder: 'その時どんな気持ちだった？' },

  // 人・コト
  { id: 'f13', theme: '有名人', question: '憧れの人は誰？', icon: '⭐', placeholder: '例：大谷翔平', reasonPlaceholder: 'どこに憧れる？' },
  { id: 'f14', theme: '言葉', question: '好きな言葉や座右の銘は？', icon: '💬', placeholder: '例：なんとかなる', reasonPlaceholder: 'なぜその言葉が好き？' },
  { id: 'f15', theme: '休日の過ごし方', question: '理想の休日の過ごし方は？', icon: '🛋️', placeholder: '例：カフェで読書', reasonPlaceholder: 'なぜそれが理想？' },
  { id: 'f16', theme: '季節のイベント', question: '一年で一番好きなイベントや行事は？', icon: '🎉', placeholder: '例：花火大会', reasonPlaceholder: 'なぜそれが好き？' },

  // モノ
  { id: 'f17', theme: '宝物', question: '一番の宝物は何？', icon: '💎', placeholder: '例：友達からの手紙', reasonPlaceholder: 'なぜ大切？' },
  { id: 'f18', theme: 'アプリ', question: '一番使ってるアプリは？（SNS以外で）', icon: '📲', placeholder: '例：Spotify', reasonPlaceholder: 'なぜよく使う？' },
  { id: 'f19', theme: '匂い', question: '好きな匂いは？', icon: '👃', placeholder: '例：雨上がりの匂い', reasonPlaceholder: 'その匂い、どんな気持ちになる？' },
  { id: 'f20', theme: '色', question: '好きな色は？', icon: '🌈', placeholder: '例：ネイビー', reasonPlaceholder: 'なぜその色？' },
];

export function getRandomFavoritesQuestion(): FavoritesQuestion {
  const lastId = localStorage.getItem('lastFavoritesQuestionId');
  const candidates = FAVORITES_QUESTIONS.filter(q => q.id !== lastId);
  const selected = candidates[Math.floor(Math.random() * candidates.length)];
  localStorage.setItem('lastFavoritesQuestionId', selected.id);
  return selected;
}

export { FAVORITES_QUESTIONS };
```

### 4.3 UI仕様（`/dig/favorites/page.tsx`）

**画面構成**:

```
┌──────────────────────────────┐
│ ← あなたの好きな○○           │
├──────────────────────────────┤
│                              │
│  🎬 今日のテーマ: 映画        │
│                              │
│  「一番好きな映画は？」        │
│                              │
│  ┌──────────────────────┐   │
│  │  入力欄               │   │  ← input（1行テキスト）
│  │  placeholder:          │   │
│  │  例：千と千尋の神隠し   │   │
│  └──────────────────────┘   │
│                              │
│  どこが好き？                 │
│  ┌──────────────────────┐   │
│  │  理由入力欄            │   │  ← textarea（2〜3行）
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │    回答する ▶          │   │  ← 好きなもの + 理由5文字以上で有効化
│  └──────────────────────┘   │
│                              │
└──────────────────────────────┘
```

**送信データ**:
```typescript
{
  type: 'favorites',
  question: '一番好きな映画は？',
  answer: '千と千尋の神隠し。理由：何度見ても新しい発見がある。特にハクとの関係性が好き',
  existingTraits: [...],
}
```

**バリデーション**: 好きなもの1文字以上 & 理由5文字以上。

### 4.4 結果ページ

ガチャ質問と同一構成。`sessionStorage` キーは `'favorites-result'`。

---

## 5. ほるトップページの改修

### 5.1 `/dig/page.tsx` の変更

既存の2つのMenuCardに加えて、3つの新機能カードを追加する。

```typescript
// 1日1回制限のステート管理
const [isGachaUsedToday, setIsGachaUsedToday] = useState(false);
const [isMetaphorUsedToday, setIsMetaphorUsedToday] = useState(false);
const [isFavoritesUsedToday, setIsFavoritesUsedToday] = useState(false);

useEffect(() => {
  setIsGachaUsedToday(isUsedToday('lastGachaDate'));
  setIsMetaphorUsedToday(isUsedToday('lastMetaphorDate'));
  setIsFavoritesUsedToday(isUsedToday('lastFavoritesDate'));
}, []);
```

**MenuCard追加（既存の2つの下に配置）**:

```typescript
<MenuCard
  title="ガチャ質問"
  description="ランダムな質問に答えて特徴発見"
  icon={Dices}  // lucide-react の Dices アイコン
  iconColor="text-violet-600"
  bgGradient="from-violet-200 to-purple-200"
  buttonGradient="from-violet-500 to-purple-500"
  href="/dig/gacha"
  disabled={isGachaUsedToday}
  disabledMessage="本日の利用回数に達しました。次回は明日ご利用できます"
/>

<MenuCard
  title="自分を○○に例えると？"
  description="比喩で自分を再発見"
  icon={Palette}  // lucide-react の Palette アイコン
  iconColor="text-rose-600"
  bgGradient="from-rose-200 to-pink-200"
  buttonGradient="from-rose-500 to-pink-500"
  href="/dig/metaphor"
  disabled={isMetaphorUsedToday}
  disabledMessage="本日の利用回数に達しました。次回は明日ご利用できます"
/>

<MenuCard
  title="あなたの好きな○○"
  description="好きなものから個性を発見"
  icon={Heart}  // lucide-react の Heart アイコン
  iconColor="text-orange-600"
  bgGradient="from-orange-200 to-amber-200"
  buttonGradient="from-orange-500 to-amber-500"
  href="/dig/favorites"
  disabled={isFavoritesUsedToday}
  disabledMessage="本日の利用回数に達しました。次回は明日ご利用できます"
/>
```

**説明テキストの変更**:

```typescript
// 既存
<p>2つの方法であなたの特徴を発見</p>
// 変更後
<p>5つの方法であなたの特徴を発見</p>
```

### 5.2 レイアウト案

デイリー系3つはセクションで分けると見やすい：

```
┌──────────────────────────────┐
│  ⛏ じっくり掘る              │  ← セクションラベル
│  ┌─ スワイプ診断 ──────────┐ │
│  ┌─ AIインタビュー ────────┐ │
│                              │
│  🎲 今日のひと掘り（1日1回） │  ← セクションラベル
│  ┌─ ガチャ質問 ────────────┐ │
│  ┌─ 自分を○○に例えると？ ──┐ │
│  ┌─ あなたの好きな○○ ──────┐ │
│                              │
│  掘り出した特徴を見にいく →   │
└──────────────────────────────┘
```

---

## 6. 実装順序

以下の順番で実装してください：

### Phase 1: 共通基盤（最優先）

1. **APIルート作成**: `src/app/api/daily-dig/route.ts`
   - `verifyAuth` による認証
   - type別プロンプト分岐
   - Gemini API呼び出し（既存の `getGeminiModel()` + リトライロジック使用）
   - レスポンスパース & エラーハンドリング

2. **質問データファイル作成**:
   - `src/lib/gachaQuestions.ts`
   - `src/lib/metaphorQuestions.ts`
   - `src/lib/favoritesQuestions.ts`

### Phase 2: 各機能のフロント実装

3. **ガチャ質問**: `src/app/(main)/dig/gacha/page.tsx` + `result/page.tsx`
4. **例え質問**: `src/app/(main)/dig/metaphor/page.tsx` + `result/page.tsx`
5. **好きなもの**: `src/app/(main)/dig/favorites/page.tsx` + `result/page.tsx`

### Phase 3: 統合

6. **ほるトップページ改修**: `src/app/(main)/dig/page.tsx` にMenuCard追加 & セクション分け

### Phase 4: テスト・調整

7. ビルド確認（`npm run build`）
8. 1日1回制限の動作確認
9. 特徴保存・トレイト一覧反映の確認
10. プロンプトチューニング（抽出される特徴の質を確認）

---

## 7. 注意事項

- **既存パターンの踏襲**: 認証 (`verifyAuth`)、API呼び出し (`authenticatedFetch`)、特徴保存 (`save-interview` → `save-traits`) はすべて既存パターンを使うこと。新しいパターンを発明しない。
- **UIコンポーネント**: `AppHeader`（`usePageHeader`経由）、`MenuCard`、`TraitCard` はすべて既存を使用。
- **グラスモーフィズム**: カード部分は `glass-card` クラスを使用。ボタンは `btn-gradient-primary` を使用。
- **エラーハンドリング**: Gemini API失敗時は「もう一度お試しください」+ リトライボタン。1日1回制限は消費しない（`markUsedToday` はAPI呼び出し前に実行するが、エラー時はリセットする設計にするか、API成功後に実行する）。
  - **推奨**: スワイプ診断と同じく、全問回答完了時に `markUsedToday` を呼び、API送信。APIエラーの場合もリミットは消費済み（シンプルさ優先）。
- **匿名ユーザー対応**: スワイプ診断と同じく、匿名ユーザーでも利用可能にする（`verifyAuth` で `isAnonymous` を弾かない）。結果の保存は `save-interview` で行うが、匿名ユーザーの場合もFirestoreに保存される（匿名UIDに紐づく）。